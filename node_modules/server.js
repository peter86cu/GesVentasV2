const WebSocket = require('ws');
const axios = require('axios');

const wss = new WebSocket.Server({ port: 7008 });

wss.on('connection', function connection(ws) {
    console.log('Nueva conexión WebSocket establecida.');

    ws.on('message', async function incoming(message) {
        console.log('Mensaje recibido:', message);

		try {
            const data = JSON.parse(message);

            // Extraer el ID de usuario y el contenido del mensaje
            const userId = data.userId;
            const messageContent = data.content;

            console.log('ID de usuario:', userId);
            console.log('Contenido del mensaje:', messageContent);

            // Puedes realizar acciones adicionales aquí con el ID de usuario

            // Ejemplo de enviar una respuesta de vuelta al cliente WebSocket
           const response = await axios.get('http://localhost:7002/notificaciones/by-user?idusuario='+userId, {
                params: {
                    mensaje: message
                }
            });

            const responseData = response.data;
            console.log('Respuesta del microservicio:', responseData);

            // Enviar la respuesta del microservicio de vuelta al cliente WebSocket
            ws.send(JSON.stringify(responseData));
        } catch (error) {
            console.error('Error al procesar el mensaje:', error.message);
            // Manejar errores y enviar mensajes de error al cliente si es necesario
        }





    });

    ws.on('close', function close() {
        console.log('Conexión WebSocket cerrada.');
    });
});

console.log('Servidor WebSocket está escuchando en el puerto 7008...');